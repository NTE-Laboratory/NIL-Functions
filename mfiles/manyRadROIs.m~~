function [sIm,yout,ROIs]=manyRadROIs(im,inv_flag,imaxis)
% Usage ... [supIm,ang_yout,ROIs]=manyRadROIs(im,inv_flag,im_axis)

if nargin<3, imaxis=[1 size(im,2) 1 size(im,1)]; end;
if nargin<2, inv_flag=0; end;
if inv_flag, max_val=max(max(im))+1; end;

dxy=0.2;
rang=[-25:3:25];
ny=4;
pord=4;

cnt=1;
found_all=0;
if exist('tmp_manyRadROIs.mat'),
  usetmp=input('  tmp File found, use it (1=Yes, 0=No)?  ');
  if usetmp==1,
    load tmp_manyRadROIs cnt ROIs yf yout
  end;
end;
while(~found_all),
  clear tmpyy rad3b pval
  if cnt>1,
    msk=sum(ROIs,3)>0;
  else,
    msk=zeros(size(im));
  end;
  good_loc=0;
  while(~good_loc)
    disp(sprintf('  select cross-section (two pixel locations)...'));
    figure(1)
    show(im_super(im,msk,0.3)), axis(imaxis),
    drawnow
    p1=round(ginput(2));
    msk=pixtoim([p1(:,2) p1(:,1)],size(im));
    show(im_super(im,msk,0.3)), axis(imaxis);
    drawnow,
    good_loc=input('  location ok? [1=yes, 0=no]: ');
  end;
  aloc(cnt,:)=mean(p1);
  dloc(cnt,:)=diff(p1);
  dd(cnt)=sqrt(sum(dloc(cnt,:).^2));
  dang(cnt)=atan(dloc(cnt,2)/dloc(cnt,1))*(180/pi);
  rw=[ny ceil(dd(cnt))];
  [tmp1,tmpmsk1]=getRectImGrid(im,rw,dxy,[aloc(cnt,2) aloc(cnt,1)],dang(cnt));
  yy{cnt}=mean(tmp1,2)';
  if inv_flag, yy{cnt}=max_val-yy{cnt}; end;
  show(im_super(im,tmpmsk1,0.3)), axis(imaxis),
  drawnow,
  disp(sprintf('  optimizing angle...'));
  for mm=1:length(rang),
    [tmpy,tmpymsk]=getRectImGrid(im,rw,dxy,[aloc(cnt,2) aloc(cnt,1)],dang(cnt)+rang(mm));
    tmpyy(mm,:)=mean(tmpy,2)';
    if inv_flag, tmpyy(mm,:)=max_val-tmpyy(mm,:); end;
    rad3b(mm,:)=calcRadius3b(tmpyy(mm,:));
  end; 
  pfit=polyfit(dang(cnt)+rang,rad3b(:,1)',pord);
  pval=polyval(pfit,dang(cnt)+rang);
  tmpri=find(rad3b(:,1)==min(rad3b(:,1)));
  tmppi=find(pval==min(pval));
  figure(2)
  plot(dang(cnt)+rang,[rad3b(:,1) pval(:)])
  xlabel('angle'), ylabel('radius'),
  if (abs(tmpri-tmppi)>6),
    dang1(cnt)=dang(cnt)+rang(tmpri);
  else,
    dang1(cnt)=dang(cnt)+rang(tmppi);
  end;
  [tmpy,tmpymsk]=getRectImGrid(im,rw,dxy,[aloc(cnt,2) aloc(cnt,1)],dang1(cnt));
  figure(1)
  show(im_super(im,tmpymsk,0.3)), axis(imaxis),
  drawnow,
  disp(sprintf('  loc# %d  ang0= %.1f  ang= %.1f  (%d,%d)',cnt,dang(cnt),dang1(cnt),tmpri,tmppi));
  good_loc=input('  ROI ok? [1=yes, 0=no, 9=yes+exit]: ');
  if (good_loc>0),
    yf{cnt}=mean(tmpy,2)';
    ROIs(:,:,cnt)=tmpymsk; 
    yout(cnt).rw=[ny ceil(dd(cnt))];
    yout(cnt).dxy=dxy;
    yout(cnt).aloc=[aloc(cnt,2) aloc(cnt,1)];
    yout(cnt).ang=dang1(cnt);
    yout(cnt).yp=yf{cnt};
    cnt=cnt+1;
    save tmp_manyRadROIs cnt ROIs yf yout
  end;
  if (good_loc)==9,
    found_all=1;
  end;
end;

sIm=zeros(size(im));
for mm=1:size(ROIs,3),
  sIm(find(ROIs(:,:,mm)))=mm;
end;

if exist('tmp_manyRadROIs.mat'),
  unix('rm tmp_manyRadROIs.mat');
end;

